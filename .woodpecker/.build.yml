matrix:
  PLATFORM:
    - linux/amd64
    - linux/arm64
    - linux/arm/v7

# These checks already get performed on the feature branches
branches:
  exclude: [ main, dev ]
platform: ${PLATFORM}

pipeline:
  vieter:
    image: 'chewingbever/vlang:latest'
    group: 'build'
    commands:
      - make vieter

  debug:
    image: 'chewingbever/vlang:latest'
    group: 'build'
    commands:
      - make debug

  prod:
    image: 'chewingbever/vlang:latest'
    environment:
      - LDFLAGS=-lz -lbz2 -llzma -lexpat -lzstd -llz4 -static
    group: 'build'
    commands:
      - make prod
      # Make sure the binary is actually static
      - readelf -d pvieter
      - du -h pvieter
      - '[ "$(readelf -d pvieter | grep NEEDED | wc -l)" = 0 ]'
