platform: linux/amd64

pipeline:
  prepare:
    image: 'chewingbever/vlang:latest'
    secrets: [ s3_username, s3_password ]
    commands:
      # Write the title to a file that the plugin can then read
      - echo "$(git describe --tags --abbrev=0 2> /dev/null || echo '0.0.0')-$(git rev-list --count ^dev)" > title
      - cat title
      - wget https://dl.min.io/client/mc/release/linux-amd64/mc
      - chmod +x mc
      - ./mc alias set s3/ https://s3.rustybever.be "$S3_USERNAME" "$S3_PASSWORD"
      - ./mc cp "s3/vieter/commits/$CI_COMMIT_SHA" assets

  release:
    image: 'plugins/gitea-release'
    secrets:
      - gitea_release_api_key
    settings:
      base_url: https://git.rustybever.be
      files: assets/*
      checksums:
        - md5
        - sha256
      prerelease: true
      # This should get read in as a file
      title: title
    when:
      event: push

depends_on:
  - build
